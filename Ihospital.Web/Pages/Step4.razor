@page "/step4"
@using Ihospital.Web.Services
@inject NavigationManager Navigation
@inject ISurveyStateService SurveyState

<PageTitle>Survey Platform - Step 4</PageTitle>

<div class="survey-container">
    <div class="survey-header">
        <h1>Survey Platform</h1>
    </div>

    <div class="survey-content">
        <h2 class="survey-title">Patient Feedback Survey – Step 4</h2>
        <p class="survey-subtitle">Please rate your room facilities</p>

        <div class="survey-form">
            <div class="form-group">
                <label>Room Facilities (Select up to 4)</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@wifi" @onchange="(e) => ToggleFacility(nameof(wifi), e)" />
                        <span>WiFi</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@mealOrderSystem" @onchange="(e) => ToggleFacility(nameof(mealOrderSystem), e)" />
                        <span>Meal Order System</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@nurseAssistantCall" @onchange="(e) => ToggleFacility(nameof(nurseAssistantCall), e)" />
                        <span>Nurse Assistant Call</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@entertainmentSystem" @onchange="(e) => ToggleFacility(nameof(entertainmentSystem), e)" />
                        <span>Entertainment System</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@climateControl" @onchange="(e) => ToggleFacility(nameof(climateControl), e)" />
                        <span>Climate Control</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@privateBathroom" @onchange="(e) => ToggleFacility(nameof(privateBathroom), e)" />
                        <span>Private Bathroom</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" checked="@visitorSeating" @onchange="(e) => ToggleFacility(nameof(visitorSeating), e)" />
                        <span>Visitor Seating</span>
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(facilityError))
                {
                    <div class="error-message">@facilityError</div>
                }
            </div>

            @* WiFi-specific questions shown only if WiFi was selected *@
            @if (wifi)
            {
                <div class="form-group">
                    <label>WiFi Service(s) Used (Select all that apply)</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" checked="@wifiService30Min" @onchange="(e) => wifiService30Min = (bool)e.Value" />
                            <span>30 Minutes Free WiFi (Reset Daily)</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" checked="@wifiService1Hour" @onchange="(e) => wifiService1Hour = (bool)e.Value" />
                            <span>$1 for 1 hour Full Speed WiFi</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" checked="@wifiService1Day" @onchange="(e) => wifiService1Day = (bool)e.Value" />
                            <span>$5 for 1 day Full Speed WiFi</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" checked="@wifiService1Week" @onchange="(e) => wifiService1Week = (bool)e.Value" />
                            <span>$20 for 1 week Full Speed WiFi</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>WiFi Satisfaction</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="wifiSatisfaction" value="Satisfied" @onchange="@(() => wifiSatisfaction = "Satisfied")" checked="@(wifiSatisfaction == "Satisfied")" />
                            <span>Satisfied</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="wifiSatisfaction" value="Neutral" @onchange="@(() => wifiSatisfaction = "Neutral")" checked="@(wifiSatisfaction == "Neutral")" />
                            <span>Neutral</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="wifiSatisfaction" value="Unsatisfied" @onchange="@(() => wifiSatisfaction = "Unsatisfied")" checked="@(wifiSatisfaction == "Unsatisfied")" />
                            <span>Unsatisfied</span>
                        </label>
                    </div>
                </div>
            }
        </div>

        <div class="form-actions">
            <button class="btn-secondary" @onclick="GoBack"><span>←</span> Back</button>
            <button class="btn-primary" @onclick="NextStep">Next <span>→</span></button>
        </div>
    </div>
</div>

@code {
    private bool wifi = false;
    private bool mealOrderSystem = false;
    private bool nurseAssistantCall = false;
    private bool entertainmentSystem = false;
    private bool climateControl = false;
    private bool privateBathroom = false;
    private bool visitorSeating = false;

    private string facilityError = string.Empty;
    
    // WiFi service options
    private bool wifiService30Min = false;
    private bool wifiService1Hour = false;
    private bool wifiService1Day = false;
    private bool wifiService1Week = false;
    
    private string wifiSatisfaction = "";

    protected override void OnInitialized()
    {
        if (SurveyState.RoomFacilities != null)
        {
            wifi = SurveyState.RoomFacilities.Contains("WiFi");
            mealOrderSystem = SurveyState.RoomFacilities.Contains("Meal Order System");
            nurseAssistantCall = SurveyState.RoomFacilities.Contains("Nurse Assistant Call");
            entertainmentSystem = SurveyState.RoomFacilities.Contains("Entertainment System");
            climateControl = SurveyState.RoomFacilities.Contains("Climate Control");
            privateBathroom = SurveyState.RoomFacilities.Contains("Private Bathroom");
            visitorSeating = SurveyState.RoomFacilities.Contains("Visitor Seating");
        }
        
        // Load WiFi services from state
        if (SurveyState.WifiServicesUsed != null)
        {
            wifiService30Min = SurveyState.WifiServicesUsed.Contains("30 Minutes Free WiFi (Reset Daily)");
            wifiService1Hour = SurveyState.WifiServicesUsed.Contains("$1 for 1 hour Full Speed WiFi");
            wifiService1Day = SurveyState.WifiServicesUsed.Contains("$5 for 1 day Full Speed WiFi");
            wifiService1Week = SurveyState.WifiServicesUsed.Contains("$20 for 1 week Full Speed WiFi");
        }
        
        if (!string.IsNullOrEmpty(SurveyState.WifiSatisfaction))
            wifiSatisfaction = SurveyState.WifiSatisfaction;
    }

    private void ToggleFacility(string facilityName, ChangeEventArgs e)
    {
        var check = e.Value is bool b && b;
        var countSelected = GetSelectedCount();

        if (check && countSelected >= 4)
        {
            facilityError = "You can select at most 4 facilities.";
            StateHasChanged();
            return;
        }

        facilityError = string.Empty;

        switch (facilityName)
        {
            case nameof(wifi):
                wifi = check;
                if (!check)
                {
                    // Reset WiFi services when WiFi is unchecked
                    wifiService30Min = false;
                    wifiService1Hour = false;
                    wifiService1Day = false;
                    wifiService1Week = false;
                    wifiSatisfaction = "";
                }
                break;
            case nameof(mealOrderSystem):
                mealOrderSystem = check;
                break;
            case nameof(nurseAssistantCall):
                nurseAssistantCall = check;
                break;
            case nameof(entertainmentSystem):
                entertainmentSystem = check;
                break;
            case nameof(climateControl):
                climateControl = check;
                break;
            case nameof(privateBathroom):
                privateBathroom = check;
                break;
            case nameof(visitorSeating):
                visitorSeating = check;
                break;
        }

        StateHasChanged();
    }

    private int GetSelectedCount()
    {
        int count = 0;
        if (wifi) count++;
        if (mealOrderSystem) count++;
        if (nurseAssistantCall) count++;
        if (entertainmentSystem) count++;
        if (climateControl) count++;
        if (privateBathroom) count++;
        if (visitorSeating) count++;
        return count;
    }

    private void NextStep()
    {
        var facilities = new List<string>();
        if (wifi) facilities.Add("WiFi");
        if (mealOrderSystem) facilities.Add("Meal Order System");
        if (nurseAssistantCall) facilities.Add("Nurse Assistant Call");
        if (entertainmentSystem) facilities.Add("Entertainment System");
        if (climateControl) facilities.Add("Climate Control");
        if (privateBathroom) facilities.Add("Private Bathroom");
        if (visitorSeating) facilities.Add("Visitor Seating");

        SurveyState.RoomFacilities = facilities;
        
        // Save WiFi services used
        var wifiServices = new List<string>();
        if (wifiService30Min) wifiServices.Add("30 Minutes Free WiFi (Reset Daily)");
        if (wifiService1Hour) wifiServices.Add("$1 for 1 hour Full Speed WiFi");
        if (wifiService1Day) wifiServices.Add("$5 for 1 day Full Speed WiFi");
        if (wifiService1Week) wifiServices.Add("$20 for 1 week Full Speed WiFi");
        
        SurveyState.WifiServicesUsed = wifiServices;
        SurveyState.WifiSatisfaction = wifiSatisfaction;

        Navigation.NavigateTo("/register");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/step3");
    }
}
